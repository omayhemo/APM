# Coherence Diagnostic Tools and Debugging Utilities

This guide covers the built-in diagnostic tools, debugging utilities, and advanced troubleshooting techniques for the Coherence - Agentic Persona Mapping.

## üîß Built-in Diagnostic Suite

### Coherence Health Check System

**Primary Health Check:**
```bash
# Comprehensive system health check
{{Coherence_ROOT}}/scripts/health-check.sh

# Quick health assessment
{{Coherence_ROOT}}/scripts/health-check.sh --quick

# Detailed health report with recommendations
{{Coherence_ROOT}}/scripts/health-check.sh --detailed --report-file health-report.html
```

**Health Check Output Example:**
```
=== Coherence Health Check Report ===
‚úì Coherence Installation: OK
‚úì Directory Structure: OK
‚úì File Permissions: OK
‚úì Voice System: OK
‚ö† Session Notes: Large files detected (recommend archiving)
‚úó Configuration: Invalid JSON in apm.json
‚úì Agent Personas: OK
‚úì Command Integration: OK

Overall Health: 85% (Good)
Critical Issues: 1
Warnings: 1
Recommendations: 3
```

---

## üîç System Diagnostic Tools

### 1. Installation Verification Tool

**Purpose:** Verify Coherence installation integrity and completeness.

```bash
# Basic installation check
{{Coherence_ROOT}}/scripts/verify-installation.sh

# Verbose installation verification
{{Coherence_ROOT}}/scripts/verify-installation.sh --verbose --check-permissions

# Installation repair mode
{{Coherence_ROOT}}/scripts/verify-installation.sh --repair --backup
```

**Verification Checks:**
- Directory structure completeness
- File permissions and ownership
- Configuration file validity
- Command integration status
- Voice system availability
- Dependencies and prerequisites

**Sample Output:**
```bash
=== Coherence Installation Verification ===

Directory Structure:
‚úì {{Coherence_ROOT}}/ exists and accessible
‚úì {{Coherence_ROOT}}/agents/ contains all required subdirectories
‚úì {{Coherence_ROOT}}/session_notes/ writable
‚úì {{Coherence_ROOT}}/config/ contains valid configurations

File Permissions:
‚úì Voice scripts executable (755)
‚úì Configuration files readable (644)
‚úì Session directory writable (755)

Command Integration:
‚úì Claude Code commands installed
‚úì Command files properly formatted
‚úì Command paths resolve correctly

Dependencies:
‚úì Bash shell available
‚úì Text-to-speech system detected
‚ö† Python3 not found (optional but recommended)

Installation Status: COMPLETE
Issues Found: 0 critical, 1 warning
```

---

### 2. Configuration Validator

**Purpose:** Validate and troubleshoot Coherence configuration files.

```bash
# Validate all configuration files
{{Coherence_ROOT}}/scripts/validate-config.sh

# Validate specific configuration
{{Coherence_ROOT}}/scripts/validate-config.sh --config apm.json

# Configuration repair and optimization
{{Coherence_ROOT}}/scripts/validate-config.sh --repair --optimize
```

**Configuration Checks:**
- JSON syntax validation
- Required fields verification
- Value range validation
- Dependency consistency
- Path resolution verification
- Performance setting optimization

**Sample Output:**
```bash
=== Configuration Validation Report ===

Main Configuration (apm.json):
‚úì Valid JSON syntax
‚úì All required fields present
‚úì Path variables resolve correctly
‚ö† PARALLEL_WORKERS (8) exceeds CPU cores (4)

Persona Configurations:
‚úì developer.json - Valid
‚úì architect.json - Valid
‚úó qa.json - Invalid: missing required field 'test_frameworks'

Voice Configuration:
‚úì TTS system configured correctly
‚úì Voice scripts accessible

Performance Configuration:
‚ö† MAX_SESSION_SIZE too large, may impact performance
‚úì Memory limits appropriate for system

Validation Result: 2 errors, 2 warnings
Recommendations: 4 optimizations available
```

---

### 3. Performance Profiler

**Purpose:** Analyze Coherence performance characteristics and identify bottlenecks.

```bash
# Basic performance profiling
{{Coherence_ROOT}}/scripts/profile-apm.sh

# Detailed performance analysis
{{Coherence_ROOT}}/scripts/profile-apm.sh --detailed --duration 60

# Real-time performance monitoring
{{Coherence_ROOT}}/scripts/profile-apm.sh --monitor --interval 5
```

**Performance Metrics:**
- Command execution times
- Memory usage patterns
- CPU utilization
- I/O performance
- Session management overhead
- Parallel operation efficiency

**Sample Output:**
```bash
=== Coherence Performance Profile ===

Command Execution Times (average over 10 runs):
/coherence activation: 1.2s (baseline: <2s) ‚úì
/dev activation: 0.8s (baseline: <3s) ‚úì
/handoff operation: 2.1s (baseline: <1s) ‚ö†
/parallel-test: 3.4s (4.2x speedup vs sequential) ‚úì

Resource Usage:
Peak Memory: 87MB (limit: 200MB) ‚úì
CPU Usage: 45% average, 78% peak ‚úì
Disk I/O: 15MB/s average ‚úì

Performance Issues Detected:
‚ö† Handoff operations slower than expected
‚ö† Large session files impacting load time

Optimization Opportunities:
- Enable session compression (estimated 20% improvement)
- Archive sessions >5MB (estimated 15% improvement)
- Tune parallel worker count (estimated 10% improvement)
```

---

## ü§ñ Agent-Specific Diagnostic Tools

### 4. Agent Health Monitor

**Purpose:** Monitor and diagnose agent-specific issues.

```bash
# Check all agents
{{Coherence_ROOT}}/scripts/agent-health-check.sh

# Check specific agent
{{Coherence_ROOT}}/scripts/agent-health-check.sh --agent developer

# Continuous agent monitoring
{{Coherence_ROOT}}/scripts/agent-health-check.sh --monitor --interval 30
```

**Agent Health Metrics:**
- Activation success rate
- Response time consistency
- Persona adherence
- Voice notification functionality
- Session handoff reliability
- Memory usage per agent

---

### 5. Session Diagnostics

**Purpose:** Analyze and troubleshoot session management.

```bash
# Analyze current session
{{Coherence_ROOT}}/scripts/analyze-session.sh

# Session history analysis
{{Coherence_ROOT}}/scripts/analyze-session.sh --history --days 7

# Session corruption detection
{{Coherence_ROOT}}/scripts/analyze-session.sh --check-corruption --repair
```

**Session Analysis Output:**
```bash
=== Session Analysis Report ===

Current Session:
File: 2025-01-15-14-30-00-Developer-Work.md
Size: 2.1MB
Age: 3 hours, 15 minutes
Entries: 47 progress updates
Status: Active, healthy

Session Statistics (last 7 days):
Total Sessions: 23
Average Duration: 2.4 hours
Average Size: 1.8MB
Largest Session: 5.2MB (archived)

Issues Detected:
‚ö† 3 sessions exceed recommended size (>5MB)
‚úì No corruption detected
‚úì All sessions properly formatted

Recommendations:
- Archive sessions >5MB for better performance
- Enable automatic session rotation
- Consider session compression for large contexts
```

---

## üî¨ Advanced Debugging Tools

### 6. Debug Mode Activation

**Purpose:** Enable detailed debugging for troubleshooting complex issues.

```bash
# Enable global debug mode
export Coherence_DEBUG=true
export Coherence_VERBOSE=true

# Enable specific debug categories
export Coherence_DEBUG_AGENTS=true
export Coherence_DEBUG_SESSION=true
export Coherence_DEBUG_VOICE=true
export Coherence_DEBUG_PARALLEL=true

# Run commands with debug output
/coherence --debug
/dev --verbose --debug
```

**Debug Categories:**
- `Coherence_DEBUG_AGENTS`: Agent activation and behavior
- `Coherence_DEBUG_SESSION`: Session management operations
- `Coherence_DEBUG_VOICE`: Voice notification system
- `Coherence_DEBUG_PARALLEL`: Parallel operation coordination
- `Coherence_DEBUG_CONFIG`: Configuration loading and validation
- `Coherence_DEBUG_PERFORMANCE`: Performance metrics collection

---

### 7. Log Analysis Tools

**Purpose:** Analyze Coherence logs for patterns, errors, and performance issues.

```bash
# Analyze all logs
{{Coherence_ROOT}}/scripts/analyze-logs.sh

# Focus on error patterns
{{Coherence_ROOT}}/scripts/analyze-logs.sh --errors --last-24h

# Performance log analysis
{{Coherence_ROOT}}/scripts/analyze-logs.sh --performance --chart
```

**Log Analysis Features:**
- Error pattern detection
- Performance trend analysis
- Resource usage patterns
- Session activity correlation
- Agent behavior analysis
- Automatic issue categorization

**Sample Log Analysis:**
```bash
=== Log Analysis Report ===

Time Range: Last 24 hours
Total Log Entries: 1,247
Errors: 3
Warnings: 12
Performance Events: 89

Error Summary:
1. Voice system timeout (2 occurrences)
2. Session file lock conflict (1 occurrence)

Performance Insights:
- Peak activity: 14:00-16:00 (87 commands/hour)
- Slowest operation: /handoff (average 2.1s)
- Memory usage trending upward (investigate)

Recommendations:
1. Investigate voice system stability
2. Review session locking mechanism
3. Monitor memory usage growth
```

---

### 8. Network Diagnostics (for Remote Operations)

**Purpose:** Diagnose network-related issues in distributed Coherence setups.

```bash
# Network connectivity check
{{Coherence_ROOT}}/scripts/network-diagnostics.sh

# Remote Coherence server diagnostics
{{Coherence_ROOT}}/scripts/network-diagnostics.sh --server apm-server.example.com

# Network performance testing
{{Coherence_ROOT}}/scripts/network-diagnostics.sh --performance-test
```

---

## üß™ Testing and Validation Tools

### 9. Integration Test Suite

**Purpose:** Comprehensive testing of Coherence functionality.

```bash
# Run full integration test suite
{{Coherence_ROOT}}/scripts/integration-tests.sh

# Quick smoke tests
{{Coherence_ROOT}}/scripts/integration-tests.sh --smoke

# Regression testing
{{Coherence_ROOT}}/scripts/integration-tests.sh --regression --baseline baseline.json
```

**Test Categories:**
- Agent activation tests
- Session management tests
- Voice system tests
- Parallel operation tests
- Configuration validation tests
- Performance regression tests

---

### 10. Stress Testing Tools

**Purpose:** Test Coherence behavior under load and stress conditions.

```bash
# Agent stress testing
{{Coherence_ROOT}}/scripts/stress-test.sh --agents --concurrent 10

# Session management stress test
{{Coherence_ROOT}}/scripts/stress-test.sh --sessions --duration 300

# Memory stress testing
{{Coherence_ROOT}}/scripts/stress-test.sh --memory --limit 500MB
```

---

## üìä Reporting and Visualization

### 11. Health Dashboard

**Purpose:** Visual dashboard for Coherence system health and performance.

```bash
# Generate health dashboard
{{Coherence_ROOT}}/scripts/generate-dashboard.sh

# Real-time dashboard (web interface)
{{Coherence_ROOT}}/scripts/dashboard-server.sh --port 8080

# Export dashboard data
{{Coherence_ROOT}}/scripts/generate-dashboard.sh --export dashboard-data.json
```

**Dashboard Features:**
- Real-time system health indicators
- Performance trend charts
- Agent activity visualization
- Resource usage graphs
- Error rate tracking
- Historical performance data

---

### 12. Diagnostic Report Generator

**Purpose:** Comprehensive diagnostic reports for support and analysis.

```bash
# Generate comprehensive diagnostic report
{{Coherence_ROOT}}/scripts/generate-diagnostic-report.sh

# Include performance data
{{Coherence_ROOT}}/scripts/generate-diagnostic-report.sh --include-performance

# Anonymized report for support
{{Coherence_ROOT}}/scripts/generate-diagnostic-report.sh --anonymize --support
```

**Report Contents:**
- System configuration summary
- Performance metrics and trends
- Error logs and analysis
- Resource usage patterns
- Agent behavior analysis
- Recommendations and action items

---

## üõ†Ô∏è Custom Diagnostic Tools

### Creating Custom Diagnostics

**Template for Custom Diagnostic Script:**
```bash
#!/bin/bash
# Custom Coherence Diagnostic Script Template

# Load Coherence environment
source {{Coherence_ROOT}}/scripts/common/coherencem-environment.sh

# Your diagnostic logic here
function custom_diagnostic() {
    echo "=== Custom Coherence Diagnostic ==="
    
    # Check specific condition
    if [ -condition ]; then
        echo "‚úì Custom check passed"
    else
        echo "‚úó Custom check failed"
    fi
}

# Run diagnostic
custom_diagnostic
```

**Integration with Coherence Diagnostic Suite:**
```bash
# Add custom diagnostic to health check
echo "source {{PROJECT_ROOT}}/custom-diagnostic.sh" >> {{Coherence_ROOT}}/config/custom-diagnostics.conf

# Run health check with custom diagnostics
{{Coherence_ROOT}}/scripts/health-check.sh --include-custom
```

---

## üÜò Emergency Diagnostic Procedures

### Emergency System Analysis

**When Coherence is completely non-functional:**

```bash
# Emergency diagnostic script (minimal dependencies)
{{Coherence_ROOT}}/scripts/emergency-diagnostic.sh

# Core system check (no Coherence dependencies)
bash -c "
echo '=== Emergency Coherence Diagnostic ==='
echo 'Timestamp: $(date)'
echo 'User: $(whoami)'
echo 'System: $(uname -a)'
echo 'Coherence Root: {{Coherence_ROOT}}'
echo 'Permissions: $(ls -ld {{Coherence_ROOT}})'
echo 'Disk Space: $(df -h {{Coherence_ROOT}})'
echo 'Processes: $(ps aux | grep -E \"claude|apm\" | wc -l)'
"
```

### Data Recovery Diagnostics

**For session data recovery:**

```bash
# Recover session data
{{Coherence_ROOT}}/scripts/recover-session-data.sh

# Validate recovered data
{{Coherence_ROOT}}/scripts/validate-recovered-data.sh

# Rebuild session index
{{Coherence_ROOT}}/scripts/rebuild-session-index.sh
```

---

## üìã Diagnostic Checklists

### Pre-Issue Diagnostic Checklist

Before reporting issues, run:

- [ ] `{{Coherence_ROOT}}/scripts/health-check.sh`
- [ ] `{{Coherence_ROOT}}/scripts/verify-installation.sh`
- [ ] `{{Coherence_ROOT}}/scripts/validate-config.sh`
- [ ] `{{Coherence_ROOT}}/scripts/analyze-logs.sh --errors`
- [ ] Check disk space: `df -h {{Coherence_ROOT}}`
- [ ] Check permissions: `ls -la {{Coherence_ROOT}}`
- [ ] Test basic functionality: `/coherence --test-mode`

### Post-Fix Validation Checklist

After applying fixes:

- [ ] `{{Coherence_ROOT}}/scripts/health-check.sh --detailed`
- [ ] Test affected functionality
- [ ] Monitor for 10 minutes with `--monitor` mode
- [ ] Generate diagnostic report for baseline
- [ ] Update documentation with lessons learned

---

## üîß Maintenance Diagnostic Tools

### Scheduled Diagnostics

**Daily Health Check:**
```bash
# Add to crontab for daily health monitoring
0 9 * * * {{Coherence_ROOT}}/scripts/health-check.sh --daily-report >> {{Coherence_ROOT}}/logs/daily-health.log
```

**Weekly Performance Analysis:**
```bash
# Weekly performance report
0 9 * * 1 {{Coherence_ROOT}}/scripts/profile-apm.sh --weekly-report >> {{Coherence_ROOT}}/logs/weekly-performance.log
```

**Monthly Comprehensive Analysis:**
```bash
# Monthly comprehensive diagnostic
0 9 1 * * {{Coherence_ROOT}}/scripts/generate-diagnostic-report.sh --monthly >> {{Coherence_ROOT}}/logs/monthly-diagnostic.log
```

---

## üìö Related Resources

- [Common Issues](common-issues.md) - Most frequent problems and solutions
- [Performance Issues](performance-issues.md) - Performance troubleshooting
- [Agent Issues](agent-issues.md) - Agent-specific troubleshooting
- [Configuration Guide](../05-configuration/README.md) - System configuration

---

*Last Updated: {{TIMESTAMP}}*
*Coherence - Agentic Persona Mapping v{{VERSION}}*